<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Neo font editor</title>
    <style>
      #dropZone {
        width: 300px;
        height: 180px;
        border: 2px dashed #aaa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Arial, sans-serif;
        color: #777;
      }
      #dropZone.hover {
        border-color: #000;
        color: #000;
      }
      textarea {
        width: 200px;
        display: inline-block;
      }

      textarea.hover {
        border-color: #000;
        color: #000;
      }

    </style>
  </head>
  <body>
<!--    <div id="dropZone">Drop files here</div>-->
    <textarea id="text" rows="100"></textarea>
    <textarea id="translation" rows="100"></textarea>

    <script type='text/javascript'>
      var Module = {
        print: (function() {
          return (...args) => {
            var text = args.join(' ');
            console.log(text);
          };
        })(),
        canvas: (() => {
            return null;
        })(),
        setStatus: (text) => {
            console.log(text);
        },
        totalDependencies: 0,
        monitorRunDependencies: (left) => {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };

      const text = document.getElementById('text');
      const translation = document.getElementById('translation');

      for (let d of [text, translation]) {
      // File drop handler
      d.addEventListener('dragover', (event) => {
        event.preventDefault();
        d.classList.add('hover');
      });

      d.addEventListener('dragleave', () => {
        d.classList.remove('hover');
      });

      d.addEventListener('drop', (event) => {
        event.preventDefault();
        d.classList.remove('hover');

        const files = event.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          const reader = new FileReader();

          reader.onload = (e) => {
        const arrayBuffer = e.target.result;
        const binaryData = new Uint8Array(arrayBuffer);

        // Pass binaryData to Emscripten Module
        Module.handleDroppedFile(binaryData);
          };

          reader.readAsArrayBuffer(file);
        }
      });
      }

      // Adding a function in Module to handle the binary data
      Module.handleDroppedFile = (binaryData) => {
        console.log('File dropped, binary data length:', binaryData.length);

        if (Module._nativeHandleDroppedData) {
          // Step 1: Allocate memory in WebAssembly for the binary data
          const buffer = Module._malloc(binaryData.length);

          if (buffer === 0) {
            console.error('Failed to allocate memory in WebAssembly');
            return;
          }

          // Step 2: Copy the JavaScript binary data into the WebAssembly memory
          Module.HEAPU8.set(binaryData, buffer);

          // Step 3: Call the C++ function with the pointer and the length of the data
          Module._nativeHandleDroppedData(buffer, binaryData.length);

          // Step 4: Free the allocated memory after use to prevent memory leaks
          Module._free(buffer);
        } else {
          console.error('Module._nativeHandleDroppedData is not available. Ensure that the C++ function is exported correctly using -s EXPORTED_FUNCTIONS=["_nativeHandleDroppedData"]');
        }
      };
      </script>

    {{{ SCRIPT }}}
  </body>
</html>
